---
name: Security Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 0 * * 0" # 毎週日曜日の00:00 UTCに実行
  workflow_dispatch: # 手動実行を許可

jobs:
  security-audit:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.10", "3.11"] # 複数バージョンでのテスト

    steps:
      # リポジトリのチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 完全な履歴を取得（一部のツールで必要）

      # Pythonのセットアップ
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # キャッシュの設定（ビルド時間短縮）
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: >-
            ${{ runner.os }}-pip-${{ matrix.python-version }}-${{
            hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      # Poetry のインストールと設定
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # Poetry設定の確認と修正
      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry config virtualenvs.prefer-active-python true

      # 依存関係のインストール
      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      # poetry.lockの整合性チェック
      - name: Check poetry.lock consistency
        run: |
          poetry check --lock
          if [ $? -ne 0 ]; then
            echo "::warning::poetry.lock is inconsistent with pyproject.toml"
            echo "Running poetry lock to fix..."
            poetry lock --no-update
          fi

      # requirements.txtの生成（pip-audit用）
      - name: Export requirements.txt
        run: |
          # 本番依存関係のみエクスポート（開発依存を除外）
          poetry export --without-hashes \
            --format=requirements.txt \
            --output requirements.txt

          # 開発依存関係も含むバージョンを生成（オプション）
          poetry export --with dev --without-hashes \
            --format=requirements.txt \
            --output requirements-dev.txt

          # 生成されたファイルの確認
          echo "Generated requirements.txt:"
          head -n 10 requirements.txt
          echo "Total dependencies: $(wc -l < requirements.txt)"

      # pip-auditのインストール
      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      # セキュリティ監査の実行
      - name: Run security audit
        id: audit
        continue-on-error: true # エラーでもワークフローを継続
        run: |
          echo "Running pip-audit on requirements.txt..."

          # JSON形式で結果を出力
          pip-audit -r requirements.txt --format json \
            > audit-results.json 2>&1 || AUDIT_EXIT=$?

          # 結果の解析
          if [ "${AUDIT_EXIT:-0}" -ne 0 ]; then
            echo "::error::Security vulnerabilities detected!"
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT

            # 脆弱性の詳細を表示
            pip-audit -r requirements.txt --desc
          else
            echo "::notice::No vulnerabilities found ✅"
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi

          # 開発依存関係の監査（オプション）
          if [ -f requirements-dev.txt ]; then
            echo "Running pip-audit on dev dependencies..."
            pip-audit -r requirements-dev.txt --format json \
              > audit-results-dev.json 2>&1 || true
          fi

      # 監査結果のアーティファクト保存
      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results-${{ matrix.python-version }}
          path: |
            audit-results.json
            audit-results-dev.json
            requirements.txt
            requirements-dev.txt
          retention-days: 30

      # Safety checkの実行（追加のセキュリティチェック）
      - name: Run Safety check
        continue-on-error: true
        run: |
          pip install safety
          safety check --json > safety-results.json 2>&1 || true

          # 結果の表示
          safety check || true

      # Banditによるコードセキュリティスキャン
      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          pip install bandit[toml]
          bandit -r . -f json -o bandit-results.json || true
          bandit -r . -ll -i || true  # 低・中レベルの問題を表示

      # 結果のサマリー生成
      - name: Generate security summary
        if: always()
        run: |
          python -c "
          import json
          import sys

          summary = []

          # pip-audit results
          try:
              with open('audit-results.json', 'r') as f:
                  data = json.load(f)
                  if isinstance(data, dict) and 'vulnerabilities' in data:
                      vulns = data['vulnerabilities']
                      summary.append(f'pip-audit: {len(vulns)} vulnerabilities found')
                      for v in vulns[:5]:  # 最初の5件を表示
                          name = v.get('name', 'Unknown')
                          vid = v.get('id', 'N/A')
                          summary.append(f'  - {name}: {vid}')
          except:
              pass

          # Safety results
          try:
              with open('safety-results.json', 'r') as f:
                  data = json.load(f)
                  if isinstance(data, list):
                      summary.append(f'Safety: {len(data)} issues found')
          except:
              pass

          # Output summary
          if summary:
              print('\n=== Security Scan Summary ===')
              for line in summary:
                  print(line)
          else:
              print('Security scans completed successfully')
          "

      # PRコメントの作成（PRの場合のみ）
      - name: Comment PR with results
        if: >-
          github.event_name == 'pull_request' &&
          steps.audit.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## 🔒 Security Audit Results\n\n';

            try {
              const auditResults = JSON.parse(
                fs.readFileSync('audit-results.json', 'utf8')
              );
              if (auditResults.vulnerabilities &&
                  auditResults.vulnerabilities.length > 0) {
                const vulnCount = auditResults.vulnerabilities.length;
                comment += `⚠️ **${vulnCount} vulnerabilities detected**\n\n`;
                comment += '| Package | Vulnerability | Severity |\n';
                comment += '|---------|--------------|----------|\n';

                auditResults.vulnerabilities.slice(0, 10).forEach(v => {
                  const name = v.name || 'Unknown';
                  const id = v.id || 'N/A';
                  const severity = v.severity || 'Unknown';
                  comment += `| ${name} | ${id} | ${severity} |\n`;
                });

                if (auditResults.vulnerabilities.length > 10) {
                  const remaining = auditResults.vulnerabilities.length - 10;
                  comment += `\n*... and ${remaining} more*\n`;
                }
              }
            } catch (e) {
              comment += '⚠️ Failed to parse audit results\n';
            }

            const repo = '${{ github.repository }}';
            const runId = '${{ github.run_id }}';
            const url = `https://github.com/${repo}/actions/runs/${runId}`;
            comment += `\n[View full report in workflow artifacts](${url})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Codecovアクションの修正版
      - name: Upload coverage to Codecov
        if: hashFiles('coverage.xml') != '' # カバレッジファイルが存在する場合のみ
        uses: codecov/codecov-action@v4 # 正しいアクション名とバージョン
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # プライベートリポジトリで必須
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false # Codecovエラーでビルドを失敗させない
          verbose: true

  # 依存関係の自動更新チェック
  dependency-check:
    runs-on: ubuntu-latest
    needs: security-audit

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check for outdated dependencies
        run: |
          poetry show --outdated

          # 自動更新の提案
          echo "::notice::Run 'poetry update' to update dependencies"

      - name: Check for Poetry configuration issues
        run: |
          # Poetry 2.x非推奨設定のチェック
          poetry config --list

          # pyproject.tomlの検証
          poetry check

          # ロックファイルの検証
          poetry lock --check
