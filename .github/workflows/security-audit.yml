---
name: Security Audit

on:
  schedule:
    - cron: "0 3 * * 0" # 毎週日曜日3時に実行
  pull_request:

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    outputs:
      level: ${{ steps.audit.outputs.level }}
      color: ${{ steps.audit.outputs.color }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache Poetry
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-1.7.1-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-1.6.1-${{ runner.os }}-

      - name: Install Poetry 1.7.1 and Export Plugin
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install "poetry==1.7.1" "poetry-plugin-export==1.7.1"

      - name: Export dependencies (runtime + dev)
        run: poetry export --with dev --format=requirements.txt --without-hashes -o requirements.txt

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit (safe)
        id: audit
        run: |
          set -e
          pip-audit -r requirements.txt --format json > audit.json || echo "[]" > audit.json
          if grep -q '"vulns":\[\]' audit.json; then
            echo "level=success" >> $GITHUB_OUTPUT
            echo "color=green" >> $GITHUB_OUTPUT
          else
            echo "level=failure" >> $GITHUB_OUTPUT
            echo "color=red" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit.json
        uses: actions/upload-artifact@v4
        with:
          name: audit-json
          path: audit.json
