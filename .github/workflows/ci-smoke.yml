name: CI smoke

on:
  push:
    branches: [ main, '**' ]   # 任意ブランチでも動作
  pull_request:                # PR でも必ず実行
  workflow_dispatch:           # 手動トリガ（任意）

jobs:
  smoke:
    runs-on: windows-latest

    env:
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"

    defaults:
      run:
        shell: pwsh

    steps:
    # 1) ソース取得 --------------------------------------------------------
    - uses: actions/checkout@v4

    # 2) Python セットアップ & pip キャッシュ ------------------------------
    - uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: pip
        cache-dependency-path: |
          **/pyproject.toml
          **/requirements*.txt

    # 3) pre‑commit キャッシュ（ダウンロード短縮） ------------------------
    - name: Cache pre-commit
      uses: actions/cache@v4
      with:
        path: ~/.cache/pre-commit
        # pre-commit config が変わったらキャッシュ無効化
        key: ${{ runner.os }}-precommit-${{ hashFiles('.pre-commit-config.yaml') }}

    # 4) dev 依存（pre-commit, black, ruff…）インストール ------------------
    - name: Install dev dependencies      # ← 先にインストール
      run: |
        python -m pip install -U pip
        python -m pip install -e '.[dev]'

    - name: Run pre-commit (lint & format)  # ← 後で実行
      run: |
        pre-commit run --show-diff-on-failure --color always --all-files

    # 5) **Lint / フォーマット統合チェック** -------------------------------
    - name: Run pre-commit (lint & format)
      run: |
        pre-commit run --show-diff-on-failure --color always --all-files

    # 6) ユニットテスト & カバレッジ etc.（既存ステップ） -----------------
    - name: Run build.ps1
      run: ./build.ps1
